import time

from matrix_pose import MatrixPose
from kuka import Kuka
import zivid
import numpy as np

app = zivid.Application()

#logging.info("Zivid object initialised")
print("Connecting to camera...")
camera = app.connect_camera()
settings = zivid.Settings.load("big_kuka_settings.yml")
frame = camera.capture(settings)
#logging.info("Connecting to camera...")

kuka = Kuka('192.168.1.147', 54600)
# kuka = Kuka('172.31.1.147', 54600)
# kuka.set_tcp([0,0,0,0,0,0])

# hm = [146.214157, 146.214157, 801.594, -135.000, -1.54562918E-12, 180.000]
# hj = [0.000000, -90.000000, 90.000000, 0.000000, 90.000000, 0.000000]
# p1 = [   395.014000,    14.256000,   770.718000,   -81.290000,     0.000000,  -180.000000 ]
# p2 = [   267.445643,    14.256220,   770.717516,   -81.411217,    -1.450826,  -170.483648 ]
# p3 = [   247.754808,   -87.505530,   779.991294,   -76.333030,    -1.450784,  -170.483975 ]
# p4 = [   240.120979,    19.805084,   779.991236,   -76.333012,    -1.450710,  -170.484484 ]
# p5 = [   275.876798,   133.770582,   755.830052,   -83.307071,   -16.287075,  -174.204853 ]
# p6 = [   255.084111,    62.752662,   755.829388,   -83.551229,    -5.078164,  -172.893248 ]
# p7 = [   261.554349,    42.292845,   741.268954,   -76.033547,    -5.078027,  -172.893455 ]
# p8 = [   261.554538,   -14.185482,   741.268955,   -91.753921,    -5.078023,  -172.893466 ]
# p9 = [   272.886477,   145.982155,   741.272081,   -89.977636,    -5.077595,  -172.894077 ]
# p10 = [   242.552885,    97.523271,   741.272095,   -75.561109,    -5.077595,  -172.894077 ]
# p11 = [   274.923127,    85.412791,   741.266505,   -75.261285,   -14.052064,  -174.681035 ]
# p12 = [   303.131405,    85.412264,   741.292804,   -89.533222,   -14.051546,  -174.676696 ]
# p13 = [   346.631272,   169.178996,   745.626020,   -87.664386,   -13.920671,  -178.895028 ]
# p14 = [   299.574949,   169.179009,   745.626041,   -88.720694,   -14.054491,  -174.526897 ]
# p15 = [   296.264809,   109.659902,   718.548336,   -88.720691,   -14.054475,  -174.526904 ]


hj = [3.000000, -74.090000, 79.250000, 2.630000, 30.190000, -94.070000]

# p1 = [  1667.433329,   159.917220,  1468.933082,   179.999534,    -3.018472,  -179.999844 ]
# p2 = [  1732.663907,   159.917215,  1468.932896,   179.999529,    -8.419345,  -179.999799 ]
# p3 = [  1737.300701,     8.303557,  1468.932862,  -177.984632,    -8.176264,   166.099369 ]
# p4 = [  1737.300663,   206.806960,  1468.933127,   179.350050,    -9.434148,  -175.560360 ]
# p5 = [  1624.639673,   206.807016,  1468.933341,   179.357853,     3.179108,  -175.702513 ]
# p6 = [  1624.639698,   206.807019,  1500.338955,  -175.352383,     1.434511,  -175.682956 ]
# p7 = [  1582.146713,   206.776755,  1457.116407,  -170.309401,     3.530340,  -175.324039 ]
# p8 = [  1582.146797,   143.377974,  1457.116362,  -170.309401,     3.530338,  -175.324038 ]
# p9 = [  1611.205847,   225.286447,  1457.116350,   166.236248,     3.530332,  -175.324038 ]
# p10 = [  1657.247054,   284.137243,  1457.116461,   168.861440,     3.530341,  -175.324042 ]
# p11 = [  1617.601734,   284.137255,  1457.116229,  -177.787866,     3.530331,  -175.324038 ]
# p12 = [  1678.884485,   284.137242,  1512.939297,  -177.784087,    -4.862251,  -175.648237 ]
# p13 = [  1722.537176,   211.727174,  1507.632574,  -171.437468,    -4.863146,  -175.648020 ]
# p14 = [  1669.647408,   194.486063,  1507.632503,  -162.853005,    -3.726150,   177.028301 ]
# p15 = [  1669.647435,   302.601409,  1507.632608,  -168.557966,    -3.726143,   177.028301 ]
#
# p16 = [  1749.324526,   -33.212856,  1482.376881,  -169.968098,    -6.000878,   156.521589 ]
# p17 = [  1779.933281,   -63.608571,  1482.376818,  -153.250028,    -6.000879,   156.521590 ]
# p18 = [  1712.544024,   -63.608560,  1482.376891,   152.720676,    -6.000876,   156.521596 ]
# p19 = [  1646.360966,   350.331835,  1482.376887,   152.524920,    10.757950,  -171.220144 ]
# p20 = [  1646.360997,   408.124672,  1482.376908,   164.307739,     8.938856,  -163.508718 ]
# p21 = [  1368.603394,   395.751120,  1439.688728,  -157.890668,     8.938855,  -163.508718 ]
# p22 = [  1301.680376,   159.917208,  1443.066427,  -150.653259,    15.528048,  -169.821309 ]
# p23 = [  1301.680396,   159.917217,  1443.066228,  -148.676585,    10.532552,  -161.078723 ]
# p24 = [  1689.687815,   490.750655,  1443.066287,   149.021512,    10.532557,  -161.078718 ]
# p25 = [  1777.608115,   490.809766,  1443.234648,   139.091732,    10.536022,  -161.083289 ]
# p26 = [  1777.608211,   490.809795,  1443.234476,  -169.944986,   -14.845997,  -165.509496 ]
# p27 = [  1777.608144,   259.147181,  1443.234569,  -169.944985,   -14.845992,  -165.509497 ]

p1 = [   531.050817,   -44.037116,   798.295596,    85.790833,     1.766817,    92.201984 ]
p2 = [   565.116344,   -20.085338,   698.717216,    91.709554,     7.219484,   100.049860 ]
p3 = [   565.119545,   -20.073056,   727.737596,    91.858359,    -3.877571,   100.898741 ]
p4 = [   565.119471,  -239.369445,   727.736041,    88.344917,    -3.877553,   100.899759 ]
p5 = [   494.858648,  -200.533159,   837.536275,    90.766710,    -7.582696,    91.818054 ]
p6 = [   450.990726,  -302.775541,   796.721247,    81.824622,   -24.062950,    90.555796 ]
p7 = [   577.672977,   124.035983,   773.973781,   126.170158,    14.001880,   104.133898 ]
p8 = [   577.679609,   243.447150,   773.965127,   102.568723,    14.001675,   104.140387 ]
p9 = [   589.217742,   265.509531,   786.484687,    78.109534,    26.365936,    96.275237 ]
p10 = [   589.231197,   265.504380,   627.820719,    99.473747,    25.504391,   103.106987 ]
p11 = [   665.339672,  -198.104007,   687.836420,    74.440669,    -6.058338,   109.932561 ]
p12 = [   691.456663,   -42.246804,   698.379215,    85.055283,    -2.580349,   109.096324 ]
p13 = [   303.299999,   -15.958738,   667.596334,    87.766094,    -4.704605,    80.254890 ]
p14 = [   303.300011,  -397.639452,   667.596311,    93.184818,   -32.357583,    78.480336 ]
p15 = [   303.302966,   338.218968,   667.597804,    93.253690,    33.376750,    81.959989 ]
p16 = [   303.305398,   338.221495,   723.627254,    82.854235,    22.673538,    81.305019 ]
p17 = [   303.305415,   338.221470,   670.910315,    82.338695,    30.576604,    80.157323 ]
p18 = [   211.117860,    20.702675,   710.509824,    93.061000,     8.976170,    75.359058 ]
p19 = [   462.504557,     3.370771,   685.570062,    91.229964,     9.271662,    93.826190 ]
p20 = [   684.116259,   -28.147124,   729.863141,    85.287376,    -2.118642,   108.943366 ]
p21 = [   583.940579,   -28.174407,   693.340753,    62.219602,    -5.355704,   103.151629 ]
p22 = [   564.548988,    81.509644,   768.848344,    89.543467,    -0.281276,   101.551394 ]
p23 = [   564.672781,   243.895374,   705.090285,    94.347182,    16.515692,   103.788196 ]
p24 = [   531.910530,    16.039915,   711.907267,    92.754512,     2.993372,    97.490949 ]
p25 = [   531.911056,  -115.028407,   711.906634,    91.383126,    -7.405189,    97.544365 ]






# poses = [p1,p16,p2,p3,p17,p4,p5,p6,p18,p7,p8,p19,p9,p20,p10,p11,p12,p21,p13,p14,p15,p22,p23,p24,p25,p26,p27]
#
poses = [p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p15,p16,p17,p20,p21,p22,p23,p24,p25]
# poses = []
correct_poses = []
frames = []
# kuka.move_lin([hm])
calibration_inputs = []
kuka.move_j(hj)
for p in poses:


    kuka.move_lin([p])
    time.sleep(3)
    frame = camera.capture(settings)
    result = zivid.calibration.detect_feature_points(frame.point_cloud())
    _,r_p,_ = kuka.get_current_state()
    robot_pose = zivid.calibration.Pose(MatrixPose.pose_to_matrix(r_p))
    # robot_pose = zivid.calibration.Pose(MatrixPose.pose_to_matrix(p))
    if result:
        print("OK")
        res = zivid.calibration.HandEyeInput(robot_pose, result)
        calibration_inputs.append(res)

    else:
        print("FAILED")


kuka.move_j(hj)
calibration_result = zivid.calibration.calibrate_eye_in_hand(calibration_inputs)
if calibration_result:
    print("OK")
    print("Result:\n{}".format(calibration_result))

    # np.savetxt(
    #     'bTz.csv',
    #     calibration_result.transform(), delimiter=",")
    print(calibration_result.transform())
    print(MatrixPose.matrix_to_pose(calibration_result.transform()))
else:
    print("FAILED")



# camera = Zivid("C:/Users/BhavinDharia/OneDrive - TetraGen Robotics Inc/Deploy/sync_software_eki/ProgramData/settings.yml")
# robot = KukaEKICommunicator('172.31.1.147', 54600,camera)
#
# for i in range(12):
#     robot.receive_data()
#
# robot.calibrate_eye_to_hand()


